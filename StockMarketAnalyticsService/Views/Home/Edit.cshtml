@using StockMarketServiceDatabase.Models.Query;
@model UserQueryModel

@{
    ViewBag.Title = Model == null || Model.Id == 0 ? "Add Query" : "Edit Query";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <h1 class="mb-4 text-center">@ViewBag.Title</h1>
    <form method="post" action="@Url.Action("SaveUserQuery", "Home")" class="row g-3">
        @Html.HiddenFor(m => m.UserId)
        @Html.HiddenFor(m => m.Id)
        <div class="col-12">
            <label for="QueryTitle" class="form-label">Query Title:</label>
            @Html.TextBoxFor(m => m.QueryTitle, new { @class = "form-control", id = "QueryTitle" })
        </div>
        
        <div class="col-12">
            <label for="Query.Filter" class="form-label">Filter:</label>
            @Html.TextBoxFor(m => m.Filter, new { @class = "form-control", id = "Query.Filter" })
        </div>

        <div class="col-12 col-md-6">
            <label for="Query.Sort" class="form-label">Sort:</label>
            @Html.TextBoxFor(m => m.Sort, new { @class = "form-control", id = "Query.Sort" })
        </div>

        <div class="col-12 col-md-6">
            <label for="Query.Select" class="form-label">Select:</label>
            @Html.TextBoxFor(m => m.Select, new { @class = "form-control", id = "Query.Select" })
        </div>

        <div class="col-12 col-md-6">
            <label for="Query.Top" class="form-label">Top:</label>
            @Html.TextBoxFor(m => m.Top, new { @class = "form-control", id = "Query.Top", type = "number" })
        </div>

        <div class="col-12 col-md-6">
            <label for="Query.Page" class="form-label">Page:</label>
            @Html.TextBoxFor(m => m.Page, new { @class = "form-control", id = "Query.Page", type = "number" })
        </div>

        <div class="col-12 text-center mt-4">
            <button type="submit" class="btn btn-primary px-4">Save</button>
            @if(Model?.Id != 0)
            {
                <button onclick="window.location.href='/Home/Execute?queryId=@Model.Id'" 
                    type="button" class="btn btn-success px-4">Execute</button>
                <button onclick="confirmDeletion('/Home/Delete?queryId=@Model.Id')"
                    type="button" class="btn btn-danger px-4">Delete</button>
            }
        </div>
    </form>
</div>
<div class="calculation-container">
    <div id="loading" style="display: none;" class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Calculating query, please wait...</p>
    </div>
    <div id="calculation-result" class="mt-4"></div>
</div>
<script>
    function confirmDeletion(url) {
        if (confirm("Are you sure you want to delete?")) {
            window.location.href = url;
        }
    }
    document.addEventListener('DOMContentLoaded', function () {
        const queryId = @Model.Id;
        if (queryId == 0) 
            return;
        // Show loading screen
        document.getElementById("loading").style.display = "block";

        // Prepare the model data
        const model = @Html.Raw(Json.Serialize(Model));
        // Send AJAX request
        fetch("/Home/CalculateQueryPart", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(model)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.text(); // Get the HTML from the response
        })
        .then(html => {
            // Inject the partial view HTML into the container
            document.getElementById("calculation-result").innerHTML = html;
            // Hide loading screen
            document.getElementById("loading").style.display = "none";
        })
        .catch(error => {
            console.error("Error:", error);
            // Hide loading screen and show an error message
            document.getElementById("loading").style.display = "none";
            //alert("An error occurred while loading the view.");
        });
    });
</script>